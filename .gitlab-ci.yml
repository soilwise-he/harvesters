stages:
  - build
workflow:
  name: 'Harvest: $PROJECT'

include:
  - local: "/CI/.cordis.yaml"
  - local: "/CI/.bonares.yaml"
  - local: "/CI/.eea-csw.yaml"
  - local: "/CI/.ejpsoil.yaml"  
  - local: "/CI/.esdac.yaml"
  - local: "/CI/.fao-csw.yaml"
  - local: "/CI/.ejpsoil.yaml"
  - local: "/CI/.it-er.yaml"
  - local: "/CI/.impact4soil.yaml"
  - local: "/CI/.inspire.yaml"
  - local: "/CI/.iso-triplify.yaml"
  - local: "/CI/.isric.yaml"
  - local: "/CI/.islandr.yaml"
  - local: "/CI/.ngr-filtered.yaml"
  - local: "/CI/.he-projects-openaire.yaml"
  - local: "/CI/.openaire.yaml"
  - local: "/CI/.prepsoil.yaml"
  - local: "/CI/.record-to-pycsw.yaml"
  - local: "/CI/.translation.yaml"
  - local: "/CI/.newsfeeds.yaml"
  - local: "/CI/.data.europa.eu.yaml"

# build a new container
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  when: on_success
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$HARBOR_REGISTRY\":{\"username\":\"$HARBOR_USER\",\"password\":\"$HARBOR_PASSWORD\"},\"$GHCR_REGISTRY\":{\"username\":\"$GHCR_USER\",\"password\":\"$GHCR_TOKEN\"}}}" > /kaniko/.docker/config.json
    - echo "build; $CI_COMMIT_REF_NAME:$CI_COMMIT_TAG@$CI_COMMIT_SHORT_SHA"
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $GHCR_REGISTRY/$GHCR_PROJECT/harvesters-soilwise:$CI_COMMIT_TAG --destination $GHCR_REGISTRY/$GHCR_PROJECT/harvesters-soilwise:latest; 
  only:
    - tags

